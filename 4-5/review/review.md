# Отчёт по индивидуальному домашнему заданию: Задача о читателях и писателях
ФИО: Оганесян Микаэл
Группа: БПИ-234
Вариант: 5
## 1. Описание задачи

Задача о читателях и писателях моделирует доступ к общей базе данных (БД), представленной массивом целых положительных чисел, двумя типами процессов: читателями и писателями. Основные требования:

- **Читатели** (N процессов) периодически читают случайные записи БД и выводят:
  - Номер процесса (PID).
  - Индекс записи.
  - Значение записи.
  - Число Фибоначчи, вычисленное для значения записи.
- **Писатели** (K процессов) изменяют случайные записи на случайные значения и выводят:
  - Номер процесса (PID).
  - Индекс записи.
  - Старое значение.
  - Новое значение.
- **База данных** изначально находится в непротиворечивом состоянии (числа отсортированы по возрастанию). После каждой записи БД переводится в новое непротиворечивое состояние (пересортировка).
- **Синхронизация**:
  - Писатели имеют исключительный доступ к БД.
  - Читатели могут работать параллельно, если нет активных писателей.
- **Реализация**: клиент-серверное приложение, где сервер моделирует БД, а клиенты (отдельные для читателей и писателей) реализуют процессы-читатели и процессы-писатели.
- **Сетевые параметры**: IP-адрес и порт задаются через командную строку.

## 2. Сценарий решаемой задачи

### Сущности и их поведение

1. **База данных**:
   - Представлена массивом целых чисел (размер 10, изначально значения 1, 2, ..., 10, отсортированы по возрастанию).
   - Хранится на сервере.
   - Поддерживает операции чтения (для читателей) и записи (для писателей).
   - После каждой записи массив пересортируется для сохранения непротиворечивого состояния.

2. **Читатели**:
   - Каждый читатель — отдельный процесс, созданный клиентом-читателем.
   - Периодически запрашивает случайную запись из БД.
   - Получает индекс и значение записи, вычисляет число Фибоначчи и выводит информацию.
   - Работают параллельно, если нет активных писателей.

3. **Писатели**:
   - Каждый писатель — отдельный процесс, созданный клиентом-писателем.
   - Периодически выбирает случайный индекс и новое значение, отправляет запрос на запись.
   - Получает подтверждение записи (индекс, старое и новое значения) и выводит информацию.
   - Имеют исключительный доступ к БД во время записи.

### Описание сущностей программы

1. **Сервер** (`server.c`):
   - Моделирует базу данных.
   - Обрабатывает запросы клиентов через TCP-сокеты.
   - Использует мьютек худы для синхронизации:
     - `db_mutex`: защищает доступ к массиву БД.
     - `rw_mutex`: управляет количеством активных читателей (`active_readers`) и писателей (`active_writers`), обеспечивая исключительный доступ писателей и параллельный доступ читателей.
   - После каждой записи сортирует БД.
   - Обрабатывает подключения клиентов в отдельных потоках.
   - Логирует запросы чтения и записи для отладки.

2. **Клиент-читатель** (`reader_client.c`):
   - Создаёт N процессов-читателей с помощью `fork()`.
   - Каждый процесс подключается к серверу через TCP-сокет, отправляет запрос `READ`, получает ответ, вычисляет число Фибоначчи и выводит информацию.
   - Периодичность запросов имитируется задержкой в 2 секунды.

3. **Клиент-писатель** (`writer_client.c`):
   - Создаёт K процессов-писателей с помощью `fork()`.
   - Каждый процесс подключается к серверу, отправляет запрос `WRITE index new_value`, получает ответ (`WROTE index old_value new_value`) и выводит информацию.
   - Периодичность запросов имитируется задержкой в 3 секунды.

### Взаимодействие

1. **Запуск**:
   - Сервер запускается с указанием IP и порта: `./server 127.0.0.1 8080`.
   - Клиент-читатель: `./reader_client 127.0.0.1 8080 3` (3 читателя).
   - Клиент-писатель: `./writer_client 127.0.0.1 8080 2` (2 писателя).

2. **Сетевое взаимодействие**:
   - Клиенты подключаются к серверу по TCP.
   - Протокол обмена:
     - Читатель отправляет: `READ`.
     - Сервер отвечает: `VALUE index value`.
     - Писатель отправляет: `WRITE index new_value`.
     - Сервер отвечает: `WROTE index old_value new_value`.

3. **Синхронизация**:
   - Писатели блокируют доступ к БД (`rw_mutex`), пока не завершат запись.
   - Читатели увеличивают счётчик `active_readers` и работают параллельно, если `active_writers == 0`.
   - Доступ к массиву `db` защищён мьютексом `db_mutex`.

4. **Завершение работы**:
   - **Клиенты**: Каждый процесс-читатель или писатель работает в бесконечном цикле до получения сигнала завершения (например, SIGINT через Ctrl+C). При завершении процесса закрывается сокет, и родительский процесс ожидает завершения всех дочерних процессов (`wait(NULL)`).
   - **Сервер**: Работает в бесконечном цикле, принимая подключения. Завершение возможно через SIGINT: сервер закрывает сокет, освобождает ресурсы (мьютексы) и завершает работу.
   - В текущей реализации завершение не реализовано явно, но может быть добавлено через обработчик сигналов (`signal(SIGINT, handler)`), который корректно завершает потоки и освобождает ресурсы.

## 3. Данные для тестового ввода

- Сервер с IP `127.0.0.1` и портом `8080`.
- Клиент-читатель с 3 читателями.
- Клиент-писатель с 2 писателями.

### Пример вывода

#### Сервер
```
Server listening on 127.0.0.1:8080
```
#### Клиент-читатель
```
Reader 1 (PID 12345): Index 5, Value 6, Fibonacci 8
Reader 2 (PID 12346): Index 7, Value 8, Fibonacci 21
Reader 3 (PID 12347): Index 2, Value 3, Fibonacci 2
```

#### Клиент-писатель
```
Writer 1 (PID 12348): Index 3, Old Value 4, New Value 42
Writer 2 (PID 12349): Index 6, Old Value 7, New Value 19
```